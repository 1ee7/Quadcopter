/*==============================================================================================*/
/*==============================================================================================*/
#include "stm32f4_system.h"
#include "stm32f4_i2c.h"
#include "module_bmp085.h"
/*==============================================================================================*/
/*==============================================================================================*
**函數 : BMP085_Init
**功能 : 
**輸入 : 
**輸出 : 
**使用 : 
**==============================================================================================*/
/*==============================================================================================*/
void BMP085_Init( u8 *ReadBuf )
{
	BMP085_ReadCof(ReadBuf);
} 
/*==============================================================================================*/
/*==============================================================================================*
**函數 : BMP085_ReadCof
**功能 : 
**輸入 : 
**輸出 : 
**使用 : 
**==============================================================================================*/
/*==============================================================================================*/
void BMP085_ReadCof( u8 *ReadBuf )
{
//	I2C_DMA_ReadReg(ReadBuf, BMP085_I2C_ADDR, BMP085_AC1_H, 22); Delay_1ms(1);
}
/*==============================================================================================*/
/*==============================================================================================*
**函數 : BMP085_Read
**功能 : 
**輸入 : 
**輸出 : 
**使用 : 
**==============================================================================================*/
/*==============================================================================================*/
void BMP085_Read( BMP085_Struct* BMP085 )
{
	u8 Tmp[3] = {0};
	s32 Pr = 0;
	s32 X1 = 0, X2 = 0, X3 = 0;
	s32 B3 = 0, B5 = 0, B6 = 0;
	u32 B4 = 0, B7 = 0;

	// Read UT
//	I2C_WriteReg(BMP085_I2C_ADDR, BMP085_CTRL, BMP085_UT);
	Delay_1ms(5);
//	I2C_ReadMultiple(BMP085_I2C_ADDR, BMP085_DATA_MSB, 2, Tmp);
	BMP085->UT = (s32)((Tmp[0]<<8)|Tmp[1]);

	// Read UP
	switch(BMP085->OSS) {
		case BMP085_UP_ULR:
			I2C_WriteReg(BMP085_I2C_ADDR, BMP085_CTRL, 0x34);
			Delay_1ms(5);
			break;
		case BMP085_UP_SR:
			I2C_WriteReg(BMP085_I2C_ADDR, BMP085_CTRL, 0x74);
			Delay_1ms(8);
			break;
		case BMP085_UP_HR:
			I2C_WriteReg(BMP085_I2C_ADDR, BMP085_CTRL, 0xB4);
			Delay_1ms(14);
			break;
		case BMP085_UP_UHR:
			I2C_WriteReg(BMP085_I2C_ADDR, BMP085_CTRL, 0xF4);
			Delay_1ms(26);
			break;
	}
	I2C_ReadMultiple(BMP085_I2C_ADDR, BMP085_DATA_MSB, 3, Tmp);
	BMP085->UP = (s32)(((Tmp[0]<<16)|(Tmp[1]<<8)|Tmp[2])>>(8-BMP085->OSS));

	// Temperature
	X1 = ((s32)BMP085->UT - BMP085->AC6) * BMP085->AC5 >> 15;
	X2 = ((s32)BMP085->MC << 11) / (X1 + BMP085->MD);
	B5 = X1 + X2;
	BMP085->Temp = (B5 + 8) >> 4;

	// Pressure
	B6 = B5 - 4000;
	X1 = (BMP085->B2 * (B6 * B6 >> 12)) >> 11;
	X2 = BMP085->AC2 * B6 >> 11;
	X3 = X1 + X2;
	B3 = (((s32)BMP085->AC1 * 4 + X3) + 2)/4;
	X1 = BMP085->AC3 * B6 >> 13;
	X2 = (BMP085->B1 * (B6 * B6 >> 12)) >> 16;
	X3 = ((X1 + X2) + 2) >> 2;
	B4 = (BMP085->AC4 * (u32) (X3 + 32768)) >> 15;
	B7 = ((u32)BMP085->UP - B3) * (50000 >> BMP085->OSS);
	if(B7 < 0x80000000)
		Pr = (B7 * 2) / B4 ;
	else
		Pr = (B7 / B4) * 2;
	X1 = (Pr >> 8) * (Pr >> 8);
	X1 = (X1 * 3038) >> 16;
	X2 = (-7357 * Pr) >> 16;
	BMP085->Press = Pr + ((X1 + X2 + 3791) >> 4);
}
/*==============================================================================================*/
/*==============================================================================================*/
